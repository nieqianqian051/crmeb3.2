<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.maijishop.crmeb.mapper.ProductCategoryMapper">

    <!-- 结果映射 -->
    <resultMap id="categoryResultMap" type="com.maijishop.crmeb.entity.ProductCategory">
        <id column="id" property="id"/>
        <result column="pid" property="pid"/>
        <result column="name" property="name"/>
        <result column="icon" property="icon"/>
        <result column="sort" property="sort"/>
        <result column="is_show" property="isShow"/>
        <result column="level" property="level"/>
        <result column="is_del" property="isDel"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 带子分类数量的结果映射 -->
    <resultMap id="categoryWithChildCountResultMap" extends="categoryResultMap" type="com.maijishop.crmeb.entity.ProductCategory">
        <result column="child_count" property="childCount"/>
    </resultMap>

    <!-- 所有分类（包括子分类数量） -->
    <select id="selectAllWithChildCount" resultMap="categoryWithChildCountResultMap">
        SELECT c.*, (SELECT COUNT(*) FROM product_category WHERE pid = c.id AND is_del = 0) AS child_count
        FROM product_category c
        WHERE c.is_del = 0
        <if test="isShow != null">
            AND c.is_show = #{isShow}
        </if>
        ORDER BY c.sort DESC, c.id ASC
    </select>

    <!-- 查询给定父级ID的所有子分类 -->
    <select id="selectAllByPid" resultMap="categoryResultMap">
        SELECT *
        FROM product_category
        WHERE pid = #{pid}
          AND is_del = 0
        <if test="isShow != null">
            AND is_show = #{isShow}
        </if>
        ORDER BY sort DESC, id ASC
    </select>

    <!-- 递归查询所有子分类 -->
    <select id="selectChildrenByPid" resultMap="categoryResultMap">
        WITH RECURSIVE cte AS (
            SELECT * FROM product_category WHERE pid = #{pid} AND is_del = 0
            <if test="isShow != null">
                AND is_show = #{isShow}
            </if>
            UNION ALL
            SELECT c.* 
            FROM product_category c 
            JOIN cte ON c.pid = cte.id 
            WHERE c.is_del = 0
            <if test="isShow != null">
                AND c.is_show = #{isShow}
            </if>
        )
        SELECT * FROM cte
        ORDER BY sort DESC, id ASC
    </select>

    <!-- 获取分类树 -->
    <select id="selectCategoryTree" resultMap="categoryResultMap">
        SELECT *
        FROM product_category
        WHERE is_del = 0
        <if test="isShow != null">
            AND is_show = #{isShow}
        </if>
        ORDER BY sort DESC, id ASC
    </select>

    <!-- 检查是否有子分类 -->
    <select id="hasChildren" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM product_category
        WHERE pid = #{categoryId}
          AND is_del = 0
    </select>

    <!-- 检查分类下是否有商品 -->
    <select id="hasProducts" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM product
        WHERE cate_id = #{categoryId}
          AND is_del = 0
    </select>
</mapper> 